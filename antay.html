<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AnTay - Get Key</title>
  <script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-database-compat.js"></script>
</head>
<body>
<script>
  const startTime = performance.now();

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MSG_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const params = new URLSearchParams(window.location.search);
  const hwid = params.get("hwid");

  if (!hwid) {
    return outputJSON("error", "Missing 'hwid' parameter");
  }

  const hwidPath = 'hwids/' + encodeURIComponent(hwid);
  const ref = db.ref(hwidPath);

  ref.once('value')
    .then(snapshot => {
      const now = Date.now();

      if (snapshot.exists()) {
        const data = snapshot.val();
        const createdAt = data.createdAt || 0;

        if (now - createdAt >= 24 * 60 * 60 * 1000) {
          ref.remove().then(() => {
            generateAndSaveKey();
          });
        } else {
          const elapsed = (performance.now() - startTime).toFixed(2);
          outputJSON("success", data.key, elapsed + "ms");
        }
      } else {
        generateAndSaveKey();
      }
    })
    .catch(err => {
      const elapsed = (performance.now() - startTime).toFixed(2);
      outputJSON("error", err.message, elapsed + "ms");
    });

  function generateAndSaveKey() {
    const key = sha256(hwid).slice(0, 32);
    const now = Date.now();
    const elapsed = (performance.now() - startTime).toFixed(2);

    db.ref(hwidPath).set({
      key: key,
      createdAt: now
    }).then(() => {
      outputJSON("success", key, elapsed + "ms");
    }).catch(err => {
      outputJSON("error", err.message, elapsed + "ms");
    });
  }

  function outputJSON(status, result, timeTaken = null) {
    const response = {
      status: status,
      result: result
    };
    if (timeTaken) response["time-taken"] = timeTaken;

    document.body.innerHTML = `<pre>${JSON.stringify(response, null, 2)}</pre>`;
    if (location.search.includes("raw=true")) {
      document.body.innerText = JSON.stringify(response);
    }
  }

  function sha256(str) {
    const buffer = new TextEncoder("utf-8").encode(str);
    return crypto.subtle.digest("SHA-256", buffer).then(hash => {
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    });
  }
</script>
</body>
</html>
