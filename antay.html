<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AnTay - Get Key</title>
  <script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: monospace; background: #f9f9f9; padding: 20px; }
    pre { background: #fff; padding: 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; }
  </style>
</head>
<body>
  <pre id="output">Loading...</pre>

  <script>
    const startTime = performance.now();

    const firebaseConfig = {
      apiKey: "AIzaSyBXVJp50mN6kzm7LT0H1TBdQmPie8l6TOo",
      authDomain: "kai-bot---get-code.firebaseapp.com",
      databaseURL: "https://kai-bot---get-code-default-rtdb.firebaseio.com",
      projectId: "kai-bot---get-code",
      storageBucket: "kai-bot---get-code.firebasestorage.app",
      messagingSenderId: "944776263204",
      appId: "1:944776263204:web:878007637128146ed70ab1",
      measurementId: "G-CZ4GKJYSG3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const params = new URLSearchParams(window.location.search);
    const hwid = params.get("hwid");

    if (!hwid) {
      return outputJSON("error", "Missing 'hwid' parameter");
    }

    const hwidPath = 'hwids/' + encodeURIComponent(hwid);
    const ref = db.ref(hwidPath);

    ref.once('value')
      .then(snapshot => {
        const now = Date.now();

        if (snapshot.exists()) {
          const data = snapshot.val();
          const createdAt = data.createdAt || 0;

          if (now - createdAt >= 24 * 60 * 60 * 1000) {
            ref.remove().then(() => {
              generateAndSaveKey();
            });
          } else {
            const elapsed = (performance.now() - startTime).toFixed(2);
            outputJSON("success", data.key, elapsed + "ms");
          }
        } else {
          generateAndSaveKey();
        }
      })
      .catch(err => {
        const elapsed = (performance.now() - startTime).toFixed(2);
        outputJSON("error", err.message, elapsed + "ms");
      });

    function generateAndSaveKey() {
      sha256(hwid).then(key => {
        const now = Date.now();
        const elapsed = (performance.now() - startTime).toFixed(2);

        db.ref(hwidPath).set({
          key: key,
          createdAt: now
        }).then(() => {
          outputJSON("success", key, elapsed + "ms");
        }).catch(err => {
          outputJSON("error", err.message, elapsed + "ms");
        });
      });
    }

    function outputJSON(status, result, timeTaken = null) {
      const response = {
        status: status,
        result: result
      };
      if (timeTaken) response["time-taken"] = timeTaken;

      document.getElementById('output').textContent = JSON.stringify(response, null, 2);
    }

    function sha256(str) {
      const buffer = new TextEncoder("utf-8").encode(str);
      return crypto.subtle.digest("SHA-256", buffer).then(hash => {
        return Array.from(new Uint8Array(hash))
          .map(b => b.toString(16).padStart(2, '0'))
          .join('').slice(0, 32);
      });
    }
  </script>
</body>
</html>
